/*
 * File:        FacetedFilter.js
 * Version:     1.0.1
 * Description: Creates user-defined search and faceted filtering tools for DataTables instances
 * Author:      Jonathan Lim-Breitbart (jbreitbart.com)
 * Created:     Thu May 26 12:10:00 PDT 2011
 * Modified:    Sun Oct 17 00:10:00 PDT 2011 by Jonathan Lim-Breitbart
 * Language:    Javascript
 * License:     LGPL
 * Project:     
 * Contact:     jbreitbart.com
 * 
 * Copyright 2011 Jonathan Lim-Breitbart, all rights reserved.
 *
 */

var FacetedFilter;(function($,window,document){FacetedFilter=function(a,b){if(!this.CLASS||this.CLASS!=="FacetedFilter"){alert("FacetedFilter Warning: FacetedFilter must be initialised with the keyword 'new'")}this.s={oTable:null,dt:null,apiIndex:null,id:null,oOpts:null,displaySide:"",width:"",scroll:null,searchOpts:[],filterOpts:[],searchLabel:"",filterLabel:"",clearSearchLabel:"",clearFilterLabel:"",searchResultsLabel:"",sidebarpos:null,callback:null,callback:null,fadeDuration:null};this.dom={sidebar:null};this.fnSettings=function(){return this.s};if(typeof b==="undefined"){b={}}FacetedFilter.aInstances.push(this);this.s.oTable=a.oInstance;this.s.dt=a;this.s.id=$.fn.dataTableExt.iApiIndex;this.dom.table=this.s.dt.nTable;this._fnConstruct(b);return this};FacetedFilter.prototype={_fnConstruct:function(a){var b=this;this._fnCustomizeSettings(a);this.dom.sidebar=document.createElement("div");this.dom.sidebar.style.position="relative";this.dom.sidebar.style.float=this.s.displaySide;this.dom.sidebar.style.width=this.s.width;this.dom.sidebar.className="FF_sidebar";this.dom.sidebar.setAttribute("id","FF_sidebar_"+this.s.id);if(this.s.searchOpts.length){this._fnSearchDefinitions(this.s.searchOpts,this.dom.sidebar)}if(this.s.filterOpts.length){this._fnFilterDefinitions(this.s.filterOpts,this.dom.sidebar)}var c=this.s.dt.nTableWrapper;$(c).before(this.dom.sidebar);if(this.s.displaySide==="left"){$(this.dom.sidebar).css("float","left");$(c).css("margin-left",$(this.dom.sidebar).outerWidth()+5)}else if(this.s.displaySide==="right"){$(this.dom.sidebar).css("float","right");$(c).css("margin-right",$(this.dom.sidebar).outerWidth()+5)}this.s.sidebarpos=$(this.dom.sidebar).offset().top;if(this.s.scroll){FacetedFilter.afnScroll.push(function(){b._fnScroll.call(b)})}this.s.initCallback()},_fnCustomizeSettings:function(a){this.s.apiIndex=this._fnDataTablesApiIndex.call(this);this.s.custom=$.extend({},FacetedFilter.DEFAULTS,a);this.s.displaySide=this.s.custom.sDisplaySide;this.s.scroll=this.s.custom.bScroll;this.s.width=this.s.custom.sWidth;this.s.searchLabel=this.s.custom.sSearchLabel;this.s.filterLabel=this.s.custom.sFilterLabel;this.s.clearSearchLabel=this.s.custom.sClearSearchLabel;this.s.clearFilterLabel=this.s.custom.sClearFilterLabel;this.s.searchResultsLabel=this.s.custom.sSearchResultsLabel;this.s.searchOpts=this.s.custom.aSearchOpts;this.s.filterOpts=this.s.custom.aFilterOpts;this.s.callback=this.s.custom.fnCallback;this.s.initCallback=this.s.custom.fnInitCallback;this.s.fadeDuration=this.s.custom.iFadeDuration},_fnDataTablesApiIndex:function(){var a;for(a=0,iLen=this.s.dt.oInstance.length;a<iLen;a++){if(this.s.dt.oInstance[a]===this.s.dt.nTable){return a}}return 0},_fnScroll:function(){var a=this;var b=$(this.dom.sidebar);if(b.is(":visible")){var c=this.s.sidebarpos;var d=this.s.dt.nTableWrapper;var e=$(d).offset().top+$(d).outerHeight();var f=$(window).scrollTop();var g=f;if(f<c){g=c;b.stop().css({top:0});this.s.sidebarpos=$(b).offset().top}else{var h;if(g+$(b).outerHeight()>e){h=e-$(b).outerHeight()-c}else{h=g-c+5}b.stop().animate({top:h},200,function(){})}}},_fnSearchDefinitions:function(searchSet,wrapper){var that=this;var callback=this.s.callback;var fadeDuration=this.s.fadeDuration;var searchHeader=document.createElement("div");searchHeader.className="side_header";searchHeader.innerHTML=this.s.searchLabel;$(searchHeader).css("margin-top","0");wrapper.appendChild(searchHeader);$.each(searchSet,function(i,item){if(typeof item.label!=="string"||typeof item.column!=="number"||typeof item.identifier!=="string"){alert("Invalid search option: "+i+", ignoring");return}var maxlength;if(typeof item.maxLength==="number"){maxlength=item.maxlength}else{maxlength=50}var searchInput=document.createElement("div");searchInput.className="search_field custom_filter";searchInput.setAttribute("id",item.identifier+"_input_"+that.s.id);var label=document.createElement("label");label.innerHTML=item.label;searchInput.appendChild(label);var input=document.createElement("input");input.setAttribute("type","text");input.setAttribute("maxlength",maxlength);searchInput.appendChild(input);wrapper.appendChild(searchInput);if(typeof item.instructions==="string"&&item.instructions!==""){var instructions=document.createElement("div");instructions.className="help custom_filter";instructions.innerHTML=item.instructions;wrapper.appendChild(instructions)}$(input).keypress(function(e){if(e.keyCode===13){var val=$(this).val();if(item.regexreplace&&typeof item.regexreplace.match==="string"&&typeof item.regexreplace.replacement==="string"){val=val.replace(eval(item.regexreplace.match),item.regexreplace.replacement)}$(that.dom.table).fadeOut(that.fadeDuration,function(){var a=$.fn.dataTableExt.iApiIndex;$.fn.dataTableExt.iApiIndex=that.s.apiIndex;that.s.oTable.fnFilter(val,item.column);that._fnAddSearchTerm(val,item);$.fn.dataTableExt.iApiIndex=a;$(this).fadeIn(fadeDuration,callback)})}})});var nSearchDisplay=this._fnSearchDisplay();wrapper.appendChild(nSearchDisplay)},_fnSearchDisplay:function(){var a=this;var b=this.s.id;var c=this.s.callback;var d=this.s.fadeDuration;var e=document.createElement("div");e.setAttribute("id","searchFilters_"+b);e.className="active_filters custom_filter";e.style.display="none";var f=document.createElement("div");f.className="active_search_header";f.innerHTML=this.s.searchResultsLabel;var g=document.createElement("a");g.setAttribute("id","clear_search_"+b);g.className="clear_search";g.innerHTML=this.s.clearSearchLabel;f.appendChild(g);e.appendChild(f);$(g).click(function(){$(a.dom.table).fadeOut(a.fadeDuration,function(){$.each(a.s.searchOpts,function(){a._fnClearSearchTerm(this)});$(this).fadeIn(d,c)})});var h=document.createElement("div");h.setAttribute("id","active_terms_"+b);e.appendChild(h);return e},_fnAddSearchTerm:function(a,b){var c=this;var d=this.s.id;var e=this.s.callback;var f=this.s.fadeDuration;if(!$("#searchFilters_"+d).is(":visible")){$("#searchFilters_"+d).slideDown();$("#clear_search_"+d).fadeIn()}if($("#"+b.identifier+"term_"+d).length){$("#"+b.identifier+"term_"+d).text(b.label+a)}else{if(a!==""){var g=document.createElement("div");g.setAttribute("id",b.identifier+"search_"+d);g.className="active_search";var h=document.createElement("div");h.setAttribute("id",b.identifier+"term_"+d);h.className="search_display";h.innerHTML=b.label+a;g.appendChild(h);var i=document.createElement("div");i.setAttribute("id",b.identifier+"clear_"+d);i.className="remove_search";$(i).append("<a>X</a>");g.appendChild(i);$("#active_terms_"+d).append(g);$(i).click(function(){$(c.dom.table).fadeOut(c.fadeDuration,function(){c._fnClearSearchTerm(b);$(this).fadeIn(f,e)})})}}},_fnClearSearchTerm:function(a){var b=this.s.id;var c=$.fn.dataTableExt.iApiIndex;$.fn.dataTableExt.iApiIndex=this.s.apiIndex;var d=$("#"+a.identifier+"search_"+b);$("#"+a.identifier+"_input_"+b+" > input").val("");$(d).remove();this.s.oTable.fnFilter("",a.column);if($("#active_terms_"+b).children().length===0){$("#searchFilters_"+b).slideUp()}$.fn.dataTableExt.iApiIndex=c},_fnFilterDefinitions:function(a,b){var c=this;var d=document.createElement("div");if($("#FF_sidebar_"+this.s.id+" .side_header").length){$(d).css("margin-top","0")}d.className="side_header";d.innerHTML=this.s.filterLabel;b.appendChild(d);$.each(a,function(a,d){if(typeof d.label!=="string"||typeof d.column!=="number"||typeof d.identifier!=="string"||typeof d.options!=="object"||!d.options.length){alert("Invalid facet set: "+a+", ignoring")}else{var e=c._fnFilterDisplay(d,a);b.appendChild(e)}})},_fnFilterDisplay:function(a,b){var c=this;var d=this.s.id;var e=this.s.callback;var f=this.s.fadeDuration;var g=document.createElement("div");g.className="active_filters custom_filter";var h=document.createElement("div");h.className="active_filters_header";h.innerHTML=a.label;var i=document.createElement("a");i.setAttribute("id","clear_"+a.identifier+"_"+d);i.className="clear_filters";i.innerHTML=this.s.clearFilterLabel;h.appendChild(i);g.appendChild(h);var j=document.createElement("div");j.setAttribute("id",a.identifier+"_terms_"+d);g.appendChild(j);$.each(a.options,function(g,h){if(typeof h.query==="string"&&typeof h.display==="string"){var i=document.createElement("div");i.setAttribute("id",h.query+"_search_"+d);i.className="active_filter";var k=document.createElement("div");k.className="filter_display";$(k).append("<a>"+h.display+"</a>");i.appendChild(k);var l=document.createElement("div");l.setAttribute("id",h.query+"_clear_"+d);l.className="remove_filter";$(l).append("<a>X</a>");i.appendChild(l);j.appendChild(i);$(i).click(function(){var b=$(this).hasClass("active")?false:true;$(c.dom.table).fadeOut(c.fadeDuration,function(){c._fnToggleFacet(a.column,a.identifier,h,i,b);$(this).fadeIn(f,e)})})}else{alert("Invalid filter option: "+b+"["+g+"]"+", ignoring")}});$(i).click(function(){c._fnClearFacets(a,this)});return g},_fnToggleFacet:function(a,b,c,d,e){var f=this;var g=this.s.id;var h=$.fn.dataTableExt.iApiIndex;$.fn.dataTableExt.iApiIndex=this.s.apiIndex;var i=this.s.dt.aoPreSearchCols[a].sSearch;var j=i.split("|");var k="";if(e){$(d).addClass("active");if(i!=""){$.each(j,function(){k+=this+"|"});k+=c.query}else{k=c.query}}else{$(d).removeClass("active");$.each(j,function(){if(this!=c.query&&this!=""){k+=this+"|"}});k=k.substring(0,k.length-1)}if(k==""){$("#clear_"+b+"_"+g).hide()}else{$("#clear_"+b+"_"+g).show()}f.s.oTable.fnFilter(k,a,true,false);$.fn.dataTableExt.iApiIndex=h},_fnClearFacets:function(a,b){var c=this;var d=this.s.id;var e=this.s.callback;var f=this.s.fadeDuration;$(b).hide();$("#"+a.identifier+"_terms_"+d+" > div").removeClass("active");$(this.dom.table).fadeOut(c.fadeDuration,function(){$.each(a.options,function(){var b=$("#"+this.query+"_search_"+d);c._fnToggleFacet(a.column,a.identifier,this,b,false)});$(this).fadeIn(f,e)})}};FacetedFilter.aInstances=[];FacetedFilter.afnScroll=[];FacetedFilter.DEFAULTS={sDisplaySide:"left",sWidth:"220px",bScroll:true,sSearchLabel:"Search",sFilterLabel:"Filter By",sClearSearchLabel:"Clear",sClearFilterLabel:"Show All",sSearchResultsLabel:"You searched for:",aSearchOpts:[],aFilterOpts:[],fnCallback:function(){},fnInitCallback:function(){},iFadeDuration:400};FacetedFilter.prototype.CLASS="FacetedFilter";FacetedFilter.VERSION="1.0.0";FacetedFilter.prototype.VERSION=FacetedFilter.VERSION;if(typeof $.fn.dataTable==="function"&&typeof $.fn.dataTableExt.fnVersionCheck==="function"&&$.fn.dataTableExt.fnVersionCheck("1.7.0")){$.fn.dataTableExt.aoFeatures.push({fnInit:function(a){var b=typeof a.oInit.oFacetedFilter!=="undefined"?a.oOpts.oFacetedFilter:{};var c=new FacetedFilter(a,b);return c.dom.sidebar},sFeature:"FacetedFilter"})}else{alert("Warning: FacetedFilter requires DataTables 1.7 or greater - www.datatables.net/download")}})(jQuery,window,document);jQuery(window).scroll(function(){for(var a=0,b=FacetedFilter.afnScroll.length;a<b;a++){FacetedFilter.afnScroll[a]()}})